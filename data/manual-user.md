# 一般利用者向け

## 目的別の操作ガイド

### ログインする
- 画面のログインフォームにユーザーIDとパスワードを入力します。
- 権限は `admin` / `requester` / `viewer` の3種類です。
- `requester` は未承認ブロックの作成・編集・削除と日別在庫の取り込みが可能です（承認済みブロックの編集やマスタ管理は不可）。
- `viewer` は閲覧専用となり、ブロック追加・移動・リサイズ・承認・保存/削除・JSONエクスポート・日別在庫取り込みなどの操作が無効化されます。
- ユーザーIDやパスワードの変更は管理者が「ユーザー管理」から行います。

### 生産計画を確認する
- 左上のメニューから「スケジュール」を選択します。
- 「前の週 / 今週 / 次の週」ボタンで週移動できます。週表示（1時間 / 2時間 / 日単位）は画面上部の選択欄で切り替えます。
- 右側の「日次在庫」欄で、日別の在庫推移を確認できます（各日付の在庫数を基準に、当日以降は製造計画の増減を反映）。

### 日別在庫を一覧で確認する
- メニューから「在庫データ」を選択します。
- 縦軸に品目、横軸に日付が並ぶ表で、取り込まれている日別在庫と出荷数を確認できます。
- 縦軸の品目名の横に単位を表示し、各日付セルは数値のみで確認できます。
- 在庫データが未取り込みの場合は、Excel取り込み画面から日別在庫を登録してください。

### 計画一覧をテーブルで確認・編集する
- メニューから「計画一覧」を選択します。
- 画面上部の検索条件で、キーワード（品目名/品目コード/メモ）と承認状態を指定して絞り込みできます。
- 一覧テーブルは横・縦ともにスクロールでき、列境界をドラッグすると横幅を手動調整できます（ダブルクリックで自動幅に戻せます）。
- 左端の「編集」ボタンは固定表示され、クリックすると対象ブロックの計画編集ダイアログが開きます。

### ブロックを追加・編集する
- ガントチャート上で空いている時間帯をクリックし、「計画編集」モーダルを開きます（閲覧者は追加不可）。
- 品目は検索可能な入力欄から選択し、右端のクリア（×）アイコンで入力を素早く消去できます。数量・メモを入力して保存してください（閲覧者は入力・保存不可）。
- 製造日と賞味期限（製造日＋賞味期限日数）はモーダル内で自動表示されます。
- モーダルの下部アクション（キャンセル / 削除 / 保存）は固定表示されるため、内容をスクロールしても常に操作できます。
- モーダル内に登録者・更新者の情報が表示されます。
- 既存ブロックはドラッグで移動、左右端をドラッグすると長さを変更できます（閲覧者は移動・長さ変更不可）。
- 同じ日・同じ時間帯に複数のブロックを重ねて配置できます。重なった場合はブロックが縦に積み上がって表示され、配置後も段位置は保持されます。
- ドラッグ移動は上下に日をまたいで移動でき、掴んだ位置を基準に動きます。勤務時間外には移動できません。
- ブロックを削除する場合は確認メッセージを表示し、了承後に削除します。
- `requester` は未承認ブロックのみ操作できます。承認済みブロックは閲覧専用です。

### 品目情報を確認する
- 「マスタ管理」画面を開き、「品目一覧」を選択して品目マスタの内容を確認します。
- 品目のレシピ（使用原料）や安全在庫（自動計算設定）・賞味期限・製造効率・包装効率・備考などの設定値もここで参照できます。
- 製造効率・包装効率は品目の単位（例: ケース/人時）付きで表示されます。
- 品目コード（品目ID）だけでなく、計画方針/安全在庫/自動計算設定/賞味期限/製造・包装効率/備考などの品目マスタ情報も保存され、再読み込み後も保持されます。
- 安全在庫は、直近N日分の出荷数に係数を掛けた値で自動計算でき、対象外の品目は手入力のみで運用できます。

### 日別在庫・マスタを取り込む
- 「Excel取り込み」画面で日別在庫・品目マスタ・原料マスタのファイルを選択し、「取り込み」ボタンで読み込みます。
- 読み込むファイルは `.xlsx` / `.xls` / `.csv` に対応しています。
- ヘッダー名が異なる場合は「ヘッダー指定（任意）」で候補を入力し、「設定を保存」で次回以降も同じ候補を利用できます。
- 日別在庫はサーバー側に保存され、日付と品目コードをキーに上書き・追加されます。
- 日別在庫は在庫数に加えて、出荷数も任意で取り込めます。
- 「最終更新」欄で直近のアップロード日時を確認できます。
- 品目マスタと原料マスタはコードをキーに更新・追加され、未掲載のデータは削除されません。
- 各カードの「CSVエクスポート」から、取り込み対象データをCSVでダウンロードできます。
- `requester` は日別在庫のみ取り込み可能です。品目・原料マスタは管理者が操作してください。

### チャットで計画を更新する（任意）
- スケジュール画面右側のチャット欄に指示を入力し送信します。
- 例: `品目コード A を 9/12 10:00から2時間、40ケース 追加して`
- 実行結果はチャットに返され、必要に応じてブロックが追加・更新されます。
- 「条件設定」では、Geminiへ送信する計画データの対象日数（デフォルト30日）を指定できます。
- チャット送信前に、指定日数に合わせて計画カレンダーが自動拡張されます。返答に範囲外の startSlot が含まれる場合は警告が表示されます。
- Geminiへ送信するチャット履歴は、直近1週間分に限定されます。
- Geminiへ送信する計画データは「過去1週間〜指定日数先」の範囲に絞り、実行日時（ISO形式）も併せて送信します。
- Geminiへ送信するメッセージは「現在の計画データ → ユーザー入力 → ユーザー制約条件」の順で構成されます。
- ブロックの作成・移動時は、割り当て理由がメモに残るように指示します。
- チャット機能と条件設定は管理者のみが利用できます。

### JSON をエクスポートする
- スケジュール画面の「JSONエクスポート」ボタンを押します（閲覧者・依頼者は実行不可）。
- 生成AI連携や外部システム連携向けのJSONがダウンロードされます。

## 操作時の注意点
- 変更内容は自動的に保存されますが、通信エラーがある場合は画面上の通知を確認してください。
- 日付や日数差分の計算は `Asia/Tokyo`（JST）基準で行われます。
- 画面上部の週移動ボタンで週を切り替えた後は、必ず内容を確認してから編集してください。
- 週移動を繰り返すと将来週まで計画を入力できます（表示範囲は自動で拡張されます）。
