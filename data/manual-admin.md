# システム管理者向け

## 運用・保守のポイント

### データ保存とバックアップ
- 計画データは `data/plan.sqlite` に保存されます。
- 品目コード（品目ID）などのマスタ情報も SQLite に保存されます。
- 日別在庫も `data/plan.sqlite` に保存され、Excel取り込み時は日付と品目コードをキーに更新・追加されます。
- Excel取り込みのヘッダー指定（任意）も SQLite に保存されます。
- 定期的に `data/` ディレクトリ全体をバックアップしてください。
- 既存の `plan.json` を移行する場合は `npm run migrate:plan` を利用します。

### 環境変数とAPIキー
- `.env` は `data/` 配下に配置します（例: `data/.env`）。
- `GEMINI_API_KEY` を設定するとチャット更新機能を有効化できます。
- モデル切り替えは `GEMINI_MODEL` または `VITE_GEMINI_MODEL` を使用します。
- Gemini チャット送信前に、指定日数に合わせて計画カレンダーが自動拡張されます。返答に範囲外の startSlot が含まれる場合は警告が表示されます。
- Geminiへ送信するチャット履歴は、直近1週間分に限定されます。
- Geminiへ送信する計画データは「過去1週間〜指定日数先」の範囲に絞り、実行日時（ISO形式）も併せて送信します。
- Geminiへ送信するメッセージは「現在の計画データ → ユーザー入力 → ユーザー制約条件」の順で構成されます。
- ブロックの作成・移動時は、割り当て理由がメモに残るように指示します。

### 認証ユーザーの管理
- 認証ユーザーは `data/auth-users.json` で管理します（ひな形は `data/auth-users.example.json`）。
- `role` は `admin`（編集可）または `viewer`（閲覧専用）を設定します。
- マスタ管理の「ユーザー管理」からユーザーID・表示名・権限・パスワードを追加/更新/削除できます。
- 画面から入力したパスワードはサーバー側で scrypt 形式のハッシュに変換して保存されます。
- `passwordHash` を直接編集する場合は scrypt 形式で保存します。更新時は必ず新しいハッシュを生成してください。
- ログイン後のセッション情報は `auth_session` Cookie に署名付きJWTとして保存されます（期限付き）。
- JWT の署名鍵は `AUTH_JWT_SECRET`（例: `data/.env`）で設定してください。

### 権限・アクセスの運用
- マスタ管理は管理者が担当し、一般利用者は閲覧中心の運用にしてください。
- マスタ管理のトップ画面から「品目一覧」「原料一覧」を開き、登録内容を更新します。
- 品目一覧では安全在庫の自動計算（直近N日出荷 × 係数）、賞味期限、製造効率、包装効率、備考などの項目を合わせて更新します。
- 単位は「ピース / ケース / セット / kg / 袋 / 枚 / 個 / 箱」から選択します。製造効率は品目単位/人時で確認できます。
- レシピ設定では原料を検索可能な入力欄から選択できます。
- 承認済みブロックはドラッグ移動や長さ変更ができないため、変更が必要な場合は承認状態を解除してください。
- 共有端末ではブラウザの自動入力やパスワード保存を無効にすることを推奨します。

### 在庫データの確認
- メニューの「在庫データ」で、取り込まれている日別在庫と出荷数を一覧で確認できます。
- 日次在庫の表示は、各日付の在庫数を基準に当日以降の製造計画を加算します。
- 品目コードの整合性が取れていない場合は行が表示されないため、品目マスタの登録とExcel取り込みの内容を合わせて確認してください。

### Excel取り込みの整備
- 取込フォーマットが変わる場合は、ヘッダー名の事前調整やテンプレート配布を行ってください。
- ヘッダー名が異なる場合は、ヘッダー指定欄で候補を入力し、「設定を保存」で共有端末に反映してください。
- ファイルを選択した後は「取り込み」ボタンで実行する運用です。
- 読み込み対象外となる品目コードは、事前に品目マスタへ追加しておく必要があります。
- 取り込み時の日別在庫は日付と品目コードをキーに更新され、差分の追加にも対応しています。
- 日別在庫には、在庫数に加えて出荷数も任意で含められることを周知してください。
- 品目マスタは安全在庫の自動計算設定（対象/対象外、参照日数、係数）と包装効率も任意列で取り込めます。
- 品目マスタと原料マスタの取り込みはコードをキーに上書き・追加され、未掲載のデータは削除されません。
- 取り込み対象のテーブルは「CSVエクスポート」ボタンでダウンロードできます。

### 長期運用の運用設計
- 週移動に合わせて計画カレンダーが前後へ拡張されるため、将来計画の入力が可能です。
- 長期運用で `data/plan.sqlite` のサイズが増えるため、定期バックアップと保管ポリシーの整備を推奨します。
- 日付や日数差分の計算は `Asia/Tokyo`（JST）基準で行われます。

### 画面テンプレートの変更
- メニュー構成や表示項目を変更した場合は、READMEとマニュアルの記載を必ず更新してください。
- 更新内容は、一般利用者向けと管理者向けの両方に反映することを推奨します。

## トラブル対応

### 計画データが表示されない場合
- `data/plan.sqlite` の存在を確認し、ファイル権限が読み書き可能か確認します。
- 開発サーバーのログで `/api/plan` のエラーが出ていないか確認します。

### チャット機能が動作しない場合
- `data/.env` に `GEMINI_API_KEY` が設定されているか確認します。
- ネットワーク設定やAPI利用制限も合わせて確認してください。
