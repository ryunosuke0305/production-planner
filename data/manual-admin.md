# システム管理者向け

## 運用・保守のポイント

### データ保存とバックアップ
- 計画データは `data/plan.sqlite` に保存されます。
- 品目コード（品目ID）などのマスタ情報も SQLite に保存されます。
- 日別在庫と受注一覧も `data/plan.sqlite` に保存され、Excel取り込み時に全件が上書きされます。
- Excel取り込みのヘッダー指定（任意）も SQLite に保存されます。
- 定期的に `data/` ディレクトリ全体をバックアップしてください。
- 既存の `plan.json` を移行する場合は `npm run migrate:plan` を利用します。

### 環境変数とAPIキー
- `.env` は `data/` 配下に配置します（例: `data/.env`）。
- `GEMINI_API_KEY` を設定するとチャット更新機能を有効化できます。
- モデル切り替えは `GEMINI_MODEL` または `VITE_GEMINI_MODEL` を使用します。
- Geminiへ送信するチャット履歴は、直近1週間分に限定されます。
- Geminiへ送信するメッセージは「現在の計画データ → ユーザー入力 → ユーザー制約条件」の順で構成されます。
- ブロックの作成・移動時は、割り当て理由がメモに残るように指示します。

### 認証ユーザーの管理
- 認証ユーザーは `data/auth-users.json` で管理します（ひな形は `data/auth-users.example.json`）。
- `role` は `admin`（編集可）または `viewer`（閲覧専用）を設定します。
- `passwordHash` は scrypt 形式で保存します。更新時は必ず新しいハッシュを生成してください。
- ログイン後のセッション情報は `data/auth-sessions.json` に保存されます。
- 画面上での管理は「マスタ管理 > ユーザー管理」から行えます（ユーザーID、表示名、権限、パスワード変更）。

### 権限・アクセスの運用
- マスタ管理は管理者が担当し、一般利用者は閲覧中心の運用にしてください。
- マスタ管理のトップ画面から「品目一覧」「原料一覧」を開き、登録内容を更新します。
- 品目一覧では賞味期限・製造効率・備考などの追加項目も合わせて更新します。
- 単位は「ピース / ケース / セット / kg / 袋 / 枚 / 個 / 箱」から選択します。製造効率は品目単位/人時で確認できます。
- レシピ設定では原料を検索可能な入力欄から選択できます。
- 承認済みブロックはドラッグ移動や長さ変更ができないため、変更が必要な場合は承認状態を解除してください。
- 共有端末ではブラウザの自動入力やパスワード保存を無効にすることを推奨します。

### Excel取り込みの整備
- 取込フォーマットが変わる場合は、ヘッダー名の事前調整やテンプレート配布を行ってください。
- ヘッダー名が異なる場合は、ヘッダー指定欄で候補を入力し、「設定を保存」で共有端末に反映してください。
- 読み込み対象外となる品目コードは、事前に品目マスタへ追加しておく必要があります。
- 取り込み時に日別在庫・受注一覧は全件置換されるため、差分更新には対応していません。
- 品目マスタと原料マスタの取り込みはコードをキーに上書き・追加され、未掲載のデータは削除されません。

### 長期運用の運用設計
- 週移動に合わせて計画カレンダーが前後へ拡張されるため、将来計画の入力が可能です。
- 長期運用で `data/plan.sqlite` のサイズが増えるため、定期バックアップと保管ポリシーの整備を推奨します。

### 画面テンプレートの変更
- メニュー構成や表示項目を変更した場合は、READMEとマニュアルの記載を必ず更新してください。
- 更新内容は、一般利用者向けと管理者向けの両方に反映することを推奨します。

## トラブル対応

### 計画データが表示されない場合
- `data/plan.sqlite` の存在を確認し、ファイル権限が読み書き可能か確認します。
- 開発サーバーのログで `/api/plan` のエラーが出ていないか確認します。

### チャット機能が動作しない場合
- `data/.env` に `GEMINI_API_KEY` が設定されているか確認します。
- ネットワーク設定やAPI利用制限も合わせて確認してください。
